{"version":3,"sources":["../../../src/webpack/resolvers/AssetResolver.ts"],"names":["AssetResolver","collect","list","name","type","platform","regex","test","RegExp","priority","queryPlatform","indexOf","reduce","acc","curr","match","exec","scale","constructor","options","apply","resolver","runtime","hooks","file","tapAsync","request","_","callback","path","fileSystem","readdir","dirname","error","result","basename","replace","split","pop","resolved","includes","map","key","Object","keys","sort","a","b","Number","resolve","logger","warn","resolvedFile","relativePath","join","debug"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","sourcesContent":["import path from 'path';\nimport escapeStringRegexp from 'escape-string-regexp';\nimport Runtime from '../../runtime/Runtime';\n\ntype Request = {\n  path: string;\n  relativePath: string;\n};\n\ntype Options = {\n  test?: RegExp;\n  platform: string;\n  runtime: Runtime;\n};\n\ntype CollectOutput = {\n  [key: string]: {\n    platform: string;\n    name: string;\n  };\n};\n\ntype CollectOptions = {\n  name: string;\n  platform: string;\n  type: string;\n};\n\nexport default class AssetResolver {\n  static test = /\\.(aac|aiff|bmp|caf|gif|html|jpeg|jpg|m4a|m4v|mov|mp3|mp4|mpeg|mpg|obj|otf|pdf|png|psd|svg|ttf|wav|webm|webp)$/;\n  static collect(\n    list: Array<string>,\n    { name, type, platform }: CollectOptions\n  ): CollectOutput {\n    const regex = /^(bmp|gif|jpg|jpeg|png|psd|tiff|webp|svg)$/.test(type)\n      ? new RegExp(\n          `^${escapeStringRegexp(\n            name\n          )}(@\\\\d+(\\\\.\\\\d+)?x)?(\\\\.(${platform}|native))?\\\\.${type}$`\n        )\n      : new RegExp(\n          `^${escapeStringRegexp(name)}(\\\\.(${platform}|native))?\\\\.${type}$`\n        );\n    const priority = (queryPlatform: string) =>\n      ['native', platform].indexOf(queryPlatform);\n\n    // Build a map of files according to the scale\n    return list.reduce(\n      (acc, curr) => {\n        const match = regex.exec(curr);\n\n        if (match) {\n          let [, scale, , , platform] = match;\n          scale = scale || '@1x';\n\n          if (\n            acc[scale] &&\n            priority(platform) < priority(acc[scale].platform)\n          ) {\n            // do nothing\n            return acc;\n          }\n\n          return { ...acc, [scale]: { platform, name: curr } };\n        }\n\n        return acc;\n      },\n      {} as CollectOutput\n    );\n  }\n\n  constructor(private options: Options) {}\n\n  apply(resolver: any) {\n    const platform = this.options.platform;\n    const test = this.options.test || AssetResolver.test;\n    const runtime = this.options.runtime;\n\n    resolver.hooks.file.tapAsync(\n      'AssetResolver',\n      (request: Request, _: any, callback: Function) => {\n        if (!test.test(request.path)) {\n          callback();\n          return;\n        }\n\n        resolver.fileSystem.readdir(\n          path.dirname(request.path),\n          (error: Error | null, result: any) => {\n            if (error) {\n              callback();\n              return;\n            }\n\n            const name = path.basename(request.path).replace(/\\.[^.]+$/, '');\n            const type = request.path.split('.').pop() || '';\n\n            let resolved = result.includes(path.basename(request.path))\n              ? request.path\n              : null;\n\n            if (!resolved) {\n              const map = AssetResolver.collect(result, {\n                name,\n                type,\n                platform,\n              });\n              const key = map['@1x']\n                ? '@1x'\n                : Object.keys(map).sort(\n                    (a, b) =>\n                      Number(a.replace(/[^\\d.]/g, '')) -\n                      Number(b.replace(/[^\\d.]/g, ''))\n                  )[0];\n\n              resolved =\n                map[key] && map[key].name\n                  ? path.resolve(path.dirname(request.path), map[key].name)\n                  : null;\n            }\n\n            if (!resolved) {\n              runtime.logger.warn(`Cannot resolve: ${request.path}`);\n              callback();\n              return;\n            }\n\n            const resolvedFile = {\n              ...request,\n              path: resolved,\n              relativePath:\n                request.relativePath &&\n                resolver.join(request.relativePath, resolved),\n              file: true,\n            };\n\n            runtime.logger.debug(\n              `Resolved file: ${request.path} <--> ${resolvedFile.path}`\n            );\n            callback(null, resolvedFile);\n          }\n        );\n      }\n    );\n  }\n}\n"],"file":"AssetResolver.js"}