{"version":3,"sources":["../../src/server/Server.ts"],"names":["Server","constructor","runtime","configPath","options","http","createServer","noInteractive","ui","NonInteractiveUI","InteractiveUI","terminal","createCompiler","compiler","Compiler","configOptions","bundleTarget","bundleMode","bundleNames","length","logger","on","Events","BUILD_START","platform","updateCompilationProgress","running","value","BUILD_PROGRESS","progress","BUILD_FAILED","message","addLogItem","enhanceWithLevel","Logger","Level","Error","BUILD_FINISHED","errors","forEach","error","attachProcessEventsListeners","createListener","exitCode","exit","name","process","dispose","resetConsole","disposeLoggerProxy","terminate","complete","listen","host","port","proxy","level","args","hijackConsole","server","Hapi","router","stripTrailingSlash","webSocketServer","ws","listener","webSocketProxy","debuggerProxy","WebSocketDebuggerProxy","register","require","events","request","response","statusCode","logServerEvent","isDebuggerConnected","platforms","start","done","eager","emit","REQUEST_BUNDLE","filename","callback","log","console","Info","event","logColor","method","toUpperCase","path","toString","tags","join","build"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","sourcesContent":["import { EnvOptions } from '../config/types';\nimport { Assign } from 'utility-types';\nimport Hapi, { ResponseObject } from '@hapi/hapi';\nimport http from 'http';\nimport ws from 'ws';\n// @ts-ignore\nimport Compiler from '@haul-bundler/core-legacy/build/compiler/Compiler';\nimport { terminal } from 'terminal-kit';\nimport Runtime from '../runtime/Runtime';\nimport setupDevtoolRoutes from './setupDevtoolRoutes';\nimport setupCompilerRoutes from './setupCompilerRoutes';\nimport setupLiveReload from './setupLiveReload';\nimport setupSymbolication from './setupSymbolication';\nimport createWebsocketProxy from './websocketProxy';\nimport WebSocketDebuggerProxy from './WebSocketDebuggerProxy';\nimport InteractiveUI from './InteractiveUI';\nimport NonInteractiveUI from './NonInteractiveUI';\nimport UserInterface from './UI';\nimport Logger from '../runtime/Logger';\nimport { container, color, modifier, pad, AnsiColor } from 'ansi-fragments';\n\ntype ServerEnvOptions = Assign<\n  Pick<EnvOptions, 'dev' | 'minify' | 'assetsDest' | 'root'>,\n  {\n    noInteractive: boolean;\n    eager: string[];\n    bundleNames: string[];\n    platforms: string[];\n  }\n>;\n\nexport default class Server {\n  compiler: any;\n  server: Hapi.Server | undefined;\n  httpServer: http.Server = http.createServer();\n  resetConsole = () => {};\n  disposeLoggerProxy = () => {};\n  ui: UserInterface;\n\n  constructor(\n    private runtime: Runtime,\n    private configPath: string,\n    private options: ServerEnvOptions\n  ) {\n    if (this.options.noInteractive) {\n      this.ui = new NonInteractiveUI(this.runtime);\n    } else {\n      this.ui = new InteractiveUI(terminal);\n    }\n  }\n\n  createCompiler() {\n    const compiler = new Compiler(\n      {\n        configPath: this.configPath,\n        configOptions: {\n          ...this.options,\n          bundleTarget: 'server',\n          bundleMode:\n            this.options.bundleNames.length > 1\n              ? 'multi-bundle'\n              : 'single-bundle',\n        },\n      },\n      this.runtime.logger\n    );\n\n    compiler.on(\n      Compiler.Events.BUILD_START,\n      ({ platform }: { platform: string }) => {\n        this.ui.updateCompilationProgress(platform, {\n          running: true,\n          value: 0,\n        });\n      }\n    );\n\n    compiler.on(\n      Compiler.Events.BUILD_PROGRESS,\n      ({ progress, platform }: { platform: string; progress: number }) => {\n        this.ui.updateCompilationProgress(platform, {\n          running: true,\n          value: progress,\n        });\n      }\n    );\n\n    compiler.on(\n      Compiler.Events.BUILD_FAILED,\n      ({ platform, message }: { platform: string; message: string }) => {\n        this.ui.updateCompilationProgress(platform, {\n          running: false,\n          value: 0,\n        });\n        this.ui.addLogItem(\n          this.runtime.logger.enhanceWithLevel(Logger.Level.Error, message)\n        );\n      }\n    );\n\n    compiler.on(\n      Compiler.Events.BUILD_FINISHED,\n      ({ platform, errors }: { platform: string; errors: string[] }) => {\n        this.ui.updateCompilationProgress(platform, {\n          running: false,\n          value: 1,\n        });\n        errors.forEach(error => {\n          this.ui.addLogItem(\n            this.runtime.logger.enhanceWithLevel(Logger.Level.Error, error)\n          );\n        });\n      }\n    );\n\n    return compiler;\n  }\n\n  attachProcessEventsListeners() {\n    const createListener = (exitCode: number) => (error: any) => {\n      this.exit(exitCode, error);\n    };\n\n    // Manually call disposal logic if pressed key is CTRL + C.\n    // 'SIGINT' signal won't be emitted on CTRL + C, because stdin is in raw mode.\n    terminal.on('key', (name: string) => {\n      if (name === 'CTRL_C') {\n        createListener(0)(null);\n      }\n    });\n    process.on('uncaughtException', createListener(1));\n    process.on('unhandledRejection', createListener(1));\n    process.on('SIGINT', createListener(0));\n    process.on('SIGTERM', createListener(2));\n  }\n\n  exit(exitCode: number, error: any | undefined) {\n    this.ui.dispose(exitCode, false);\n    this.resetConsole();\n    this.disposeLoggerProxy();\n    this.compiler.terminate();\n    if (error) {\n      this.runtime.logger.error(error);\n    }\n    this.runtime.complete(exitCode);\n  }\n\n  async listen(host: string, port: number) {\n    // Proxy logs from runtime to interactive server UI only when server is running\n    // in interactive mode.\n    if (!this.options.noInteractive) {\n      this.disposeLoggerProxy = this.runtime.logger.proxy((level, ...args) => {\n        this.ui.addLogItem(\n          this.runtime.logger.enhanceWithLevel(level, ...args)\n        );\n      });\n    }\n\n    this.resetConsole = this.hijackConsole();\n    this.compiler = this.createCompiler();\n    this.attachProcessEventsListeners();\n\n    const server = new Hapi.Server({\n      port,\n      host,\n      router: {\n        stripTrailingSlash: true,\n      },\n    });\n\n    const webSocketServer = new ws.Server({ server: server.listener });\n    const webSocketProxy = createWebsocketProxy(\n      webSocketServer,\n      '/debugger-proxy'\n    );\n    const debuggerProxy = new WebSocketDebuggerProxy(\n      this.runtime,\n      webSocketProxy\n    );\n\n    await server.register(require('@hapi/inert'));\n\n    server.events.on('response', request => {\n      if ('statusCode' in request.response) {\n        if (request.response.statusCode < 400) {\n          this.logServerEvent(request);\n        } else {\n          this.logServerEvent(request);\n        }\n      }\n    });\n\n    setupSymbolication(this.runtime, server, {\n      bundleNames: this.options.bundleNames,\n    });\n    setupLiveReload(this.runtime, server, this.compiler);\n    setupDevtoolRoutes(this.runtime, server, {\n      isDebuggerConnected: () => debuggerProxy.isDebuggerConnected(),\n    });\n    setupCompilerRoutes(this.runtime, server, this.compiler, {\n      port,\n      bundleNames: this.options.bundleNames,\n      platforms: this.options.platforms,\n    });\n\n    await server.start();\n    this.ui.start(this.options.platforms);\n    this.runtime.logger.done(\n      `Packager server running on http://${host}:${port}`\n    );\n\n    this.options.eager.forEach(platform => {\n      this.compiler.emit(Compiler.Events.REQUEST_BUNDLE, {\n        filename: `/index.${platform}.bundle`, // NOTE: maybe the entry bundle is arbitrary\n        platform,\n        callback() {},\n      });\n    });\n  }\n\n  hijackConsole() {\n    if (this.options.noInteractive) {\n      return () => {};\n    }\n\n    /* eslint-disable no-console */\n    const log = console.log;\n    const error = console.error;\n\n    console.log = (...args) => {\n      this.ui.addLogItem(\n        this.runtime.logger.enhanceWithLevel(Logger.Level.Info, ...args)\n      );\n    };\n\n    console.error = (...args) => {\n      this.ui.addLogItem(\n        this.runtime.logger.enhanceWithLevel(Logger.Level.Error, ...args)\n      );\n    };\n\n    return () => {\n      console.log = log;\n      console.error = error;\n    };\n    /* eslint-enable no-console */\n  }\n\n  logServerEvent(request: Hapi.Request, event?: Hapi.RequestEvent) {\n    const { statusCode } = request.response as ResponseObject;\n    let logColor: AnsiColor = 'green';\n    let level: 'info' | 'warn' | 'error' = 'info';\n    if (statusCode >= 300 && statusCode < 400) {\n      logColor = 'yellow';\n      level = 'warn';\n    } else if (statusCode >= 400) {\n      logColor = 'red';\n      level = 'error';\n    }\n    this.runtime.logger[level](\n      container(\n        color(logColor, modifier('bold', request.method.toUpperCase())),\n        pad(1),\n        request.path,\n        pad(1),\n        color('gray', statusCode.toString()),\n        event ? event.tags.join(' ') : ''\n      ).build()\n    );\n  }\n}\n"],"file":"Server.js"}