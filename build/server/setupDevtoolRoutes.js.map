{"version":3,"sources":["../../src/server/setupDevtoolRoutes.ts"],"names":["setupDevtoolRoutes","runtime","server","isDebuggerConnected","route","method","path","handler","request","raw","req","socket","localPort","options","validate","payload","file","Joi","string","required","lineNumber","number","column","methodName","url","output","parse","h","filename","Date","now","message","logger","enhanceWithModifier","fs","writeFile","info","error","response","code","join","__dirname","confine","directory","redirectToSlash"],"mappings":"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","sourcesContent":["import path from 'path';\nimport fs from 'fs';\nimport Hapi from '@hapi/hapi';\nimport Joi from '@hapi/joi';\nimport launchBrowser from './launchBrowser';\nimport Runtime from '../runtime/Runtime';\nimport openInEditor from './openInEditor';\nimport { promisify } from 'util';\n\nexport default function setupDevtoolRoutes(\n  runtime: Runtime,\n  server: Hapi.Server,\n  { isDebuggerConnected }: { isDebuggerConnected: () => boolean }\n) {\n  server.route({\n    method: 'GET',\n    path: '/launch-js-devtools',\n    handler: request => {\n      // Open debugger page only if it's not already open.\n      if (!isDebuggerConnected()) {\n        launchBrowser(\n          runtime,\n          `http://localhost:${request.raw.req.socket.localPort}/debugger-ui`\n        );\n      }\n      return 'OK';\n    },\n  });\n\n  server.route({\n    method: 'POST',\n    path: '/open-stack-frame',\n    options: {\n      validate: {\n        payload: {\n          file: Joi.string().required(),\n          lineNumber: Joi.number().required(),\n          column: Joi.number().required(),\n          methodName: Joi.string().required(),\n        },\n      },\n    },\n    handler: async request => {\n      const { file, lineNumber, column } = request.payload as {\n        lineNumber: number;\n        column: number;\n        file: string;\n      };\n      const url = `${file}:${lineNumber}:${column}`;\n      await openInEditor(runtime, url);\n\n      return 'OK';\n    },\n  });\n\n  server.route({\n    method: 'POST',\n    path: '/systrace',\n    options: {\n      payload: {\n        output: 'data',\n        parse: false,\n      },\n    },\n    handler: async (request, h) => {\n      const filename = `/tmp/haul_${Date.now()}.json`;\n      const message = `We've saved the trace report at ${runtime.logger.enhanceWithModifier(\n        'bold',\n        filename\n      )}\\nYou can open the trace report in Google Chrome by navigating to 'chrome://tracing' and clicking 'load'.`;\n      try {\n        await promisify(fs.writeFile)(filename, request.payload);\n        runtime.logger.info(message);\n      } catch (error) {\n        return h.response().code(200);\n      }\n\n      return message;\n    },\n  });\n\n  server.route({\n    method: 'GET',\n    path: '/status',\n    handler: () => 'packager-status:running',\n  });\n\n  server.route({\n    method: 'GET',\n    path: '/debugger-ui',\n    handler: {\n      file: {\n        path: path.join(__dirname, '../../assets/debugger.html'),\n        confine: false,\n      },\n    },\n  });\n\n  server.route({\n    method: 'GET',\n    path: '/debugger-ui/{param*}',\n    handler: {\n      directory: {\n        path: path.join(__dirname, '../../assets'),\n        redirectToSlash: true,\n      },\n    },\n  });\n}\n"],"file":"setupDevtoolRoutes.js"}